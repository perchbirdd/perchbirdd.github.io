<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>From Scratch: Berry Patch</title>
		<meta name="description" content="Maybe not completely from scratch">
		<link rel="alternate" href="feed/feed.xml" type="application/atom+xml" title="perch posts">
		
		<style>/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
/* This is an arbitrary CSS string added to the bundle */
/* Defaults */
:root {
	--font-family: Atkinson Hyperlegible, -apple-system, system-ui, sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: #082840;
	--text-color-link-active: #5f2b48;
	--text-color-link-visited: #17050F;

	--syntax-tab-size: 2;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		--text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

@view-transition {
	navigation: auto;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	font-size: 1.1em;
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
body {
	max-width: 55em;
}

blockquote {
    border-left: 4px solid #4c4c4c;
    margin: 1.5rem 0;
    padding: 0 1rem;
    color: #666;
    font-style: italic;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

/* Fluid images via https://www.zachleat.com/web/fluid-images/ */
img {
  max-width: 100%;
  	border-radius: 12px;
	overflow: hidden;
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}
img[width][height] {
  height: auto;
}
img[src$=".svg"] {
  width: 100%;
  height: auto;
  max-width: none;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

main,
footer {
	padding: 1rem;
}
main :first-child {
	margin-top: 0;
}

header {
	border-bottom: 1px dashed var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	display: flex;
	justify-content: space-between;
	gap: .5em 1em;
	list-style: "";
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}
.links-nextprev > * {
	flex-grow: 1;
}
.links-nextprev-next {
	text-align: right;
}

/*
table {
	margin: 1em 0;
	border-collapse: collapse;
}
table td,
table th {
	padding-right: 1em;
}
/* table tr:nth-child(even) {
	background-color: #f2f2f2;
}  */

table {
	/* width: 100%; */
	border-collapse: collapse;
	font-size: 14px;
	line-height: 1.6;
	
	/* max-width: 800px; */
	/* margin: 0 auto; */
	/* background-color: #16213e; */
	border-radius: 8px;
	overflow: hidden;
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

th {
	background-color: #0f172a;
	color: #e2e8f0;
	font-weight: 600;
	text-align: left;
	padding: 16px 20px;
	font-size: 13px;
	/* text-transform: uppercase; */
	letter-spacing: 0.5px;
	border-bottom: 1px solid #334155;
}

td {
	padding: 16px 20px;
	border-bottom: 1px solid rgba(51, 65, 85, 0.3);
}

tr:last-child td {
	border-bottom: none;
}

th:not(:last-child),
td:not(:last-child) {
	border-right: 1px solid rgba(51, 65, 85, 0.2);
}

pre,
code {
	font-size: 85%;
	font-family: var(--font-family-monospace);
}
code[class*="language-"],
pre[class*="language-"] {
	font-size: 85%;
}

pre:not([class*="language-"]) {
	padding: 1em;
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	overflow-x: auto;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1em; /* 16px /16 */
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
	padding-left: 1.5rem;
}
.postlist-item {
	display: flex;
	flex-wrap: wrap;
	align-items: baseline;
	counter-increment: start-from -1;
	margin-bottom: 1em;
}
.postlist-item:before {
	display: inline-block;
	pointer-events: none;
	content: "" counter(start-from, decimal-leading-zero) ". ";
	line-height: 100%;
	text-align: right;
	margin-left: -1.5rem;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
	padding-left: .25em;
	padding-right: .5em;
	text-underline-position: from-font;
	text-underline-offset: 0;
	text-decoration-thickness: 1px;
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
}
.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	/* display: inline-flex; */
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
}
.post-tag {
	display: inline-flex;
}
.post-metadata time {
	margin-right: 1em;
}
.post-subtitle {
	margin-top: -1.5em;
	font-size: 75%;
	font-style: italic;
}

.collapsible-code-wrapper {
    margin: 1rem 0;
    border: 1px solid #e1e5e9;
    /* border-radius: 6px; */
    overflow: hidden;

	border-radius: 12px;
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.code-toggle {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #f6f8fa;
    border: none;
    border-bottom: 1px solid #e1e5e9;
    cursor: pointer;
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 500;
    color: #24292e;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.2s ease;
}

.code-toggle:hover {
    background: #e1e5e9;
}

.toggle-icon {
    font-size: 0.8rem;
    transition: transform 0.2s ease;
}

.toggle-text {
    font-weight: 600;
    color: #586069;
}

.code-container {
    transition: all 0.3s ease;
}

.code-container pre {
    margin: 0;
    border: none;
    border-radius: 0;
}

@media (prefers-color-scheme: dark) {
    .collapsible-code-wrapper {
        border-color: #30363d;
    }
    
    .code-toggle {
        background: #21262d;
        border-bottom-color: #30363d;
        color: #c9d1d9;
    }
    
    .code-toggle:hover {
        background: #30363d;
    }
    
    .toggle-text {
        color: #8b949e;
    }
}</style>
		<!-- <style>@import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,500;1,100..900&display=swap');</style> -->
		<style>@import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap');</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">perch posts</a>
			<nav>
				<h2 class="visually-hidden" id="top-level-navigation-menu">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">Home</a></li>
					<li class="nav-item"><a href="/about/">About</a></li>
					<li class="nav-item"><a href="/feed/feed.xml">Feed</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			<heading-anchors>
				
<h1 class="post-title" id="from-scratch-berry-patch">From Scratch: Berry Patch</h1>
<p class="post-subtitle">Maybe not completely from scratch</p>

<ul class="post-metadata">
	<li>date: <time datetime="2025-07-09">09 July 2025</time></li>
	<li class="post-tag">tags:</li>
	<li class="post-tag"><a href="/tags/pokemon/" class="post-tag">Pokémon</a>, </li>
	<li class="post-tag"><a href="/tags/reverse-engineering/" class="post-tag">reverse engineering</a>, </li>
	<li class="post-tag"><a href="/tags/game-boy-advance/" class="post-tag">game boy advance</a></li>
</ul>

<p>Recently, I learned that Pokémon Ruby and Sapphire were affected by a clock-related bug. After 366 days of gameplay, clock-based events ceased to function, as if time had stopped. If a player waited one year after the bug began, it would actually fix itself. Even more interesting to me was that a number of Pokémon games released after Ruby and Sapphire included a &quot;Berry Program Update&quot; that could be sent to the Ruby or Sapphire game cartridge to fix this bug either before it happened or while it was happening. I had searched online for more information, but the few explanations of the bug and the Berry Patch that I did find weren't technical enough for my liking. On the other hand, I didn't look too hard for explanations because I wanted to explore it myself. Let's get started!</p>
<h1 id="what-happens">What Happens</h1>
<p>On Nintendo's official website, they state:</p>
<blockquote>
<p>In Pokémon Ruby and Pokémon Sapphire, certain berry trees will stop producing berries after you've played your game for one year. All main game play activities, such as collecting and battling Pokémon, are not affected. If you want to keep the berries growing after a year of game play, please use the information below to find out how to update your game pak.</p>
</blockquote>
<p><a href="https://bulbapedia.bulbagarden.net/wiki/Berry_glitch#Explanation">Bulbapedia</a> has a lot more information:</p>
<blockquote>
<p>The game cartridge contains a real-time clock (RTC) which keeps track of the year, month, day, hour, minute, second, and day of the week. When the RTC is first turned on, its date is set to January 1, 2000. Because the game has no need for an actual calendar system, it converts the RTC's year, month, and day data into a single &quot;day number&quot;. The conversion function has a flaw, however: it will only count years (adding 365 or 366 days for each year or leap year) starting from 2001. So, while the RTC clock is reporting the year as 2000 or 2001, in both cases, the conversion equates this to &quot;add 0 days to the day number&quot;. This means that, for the first 366 days the RTC runs (starting from January 1, 2000), the game's day number will count from 1 to 366 normally, but when the RTC clock reports January 1, 2001, the game's day number will start from 1 again.<br>
If, for example, a Sitrus Berry was planted on December 31, 2000 according to the RTC, which the game interprets as day 366, it will be scheduled to be fully grown on day 367. Due to the glitch, day 367 will not happen until the RTC reaches January 2, 2002. The result is that the growth of the Berry appears to be frozen for 366 days. Other effects of this glitch include:<br>
- Random events which are calculated once per day, including the random number for Mirage Island and weather conditions on Route 119 and Route 123, along with random events which must be announced on TV, such as the Energy Guru and Lilycove Dept. Store sales and service days at the Mauville Game Corner, will be frozen until 366 days after the game was last played before the glitch took effect.<br>
- Drawings at the Pokémon Lottery Corner, NPCs who offer free Berries daily, and the man in Pacifidlog Town who gives TM27 (Return) or TM21 (Frustration) weekly will be frozen until 366 days after these events were last used.<br>
- The number of successful rocket launches at the Mossdeep Space Center will be reset to 1.<br>
The glitch does not affect the Evolution of Eevee into Espeon or Umbreon or the tides in Shoal Cave because these events are based only on the current time, not the day number.</p>
</blockquote>
<p>Given this, let's lay out the facts:</p>
<ul>
<li>The cartridge contains a real time clock (RTC) which initializes itself to January 1, 2000, and continues counting upwards until it loses power or is set otherwise</li>
<li>Ruby and Sapphire store a day number in the save file which is used to determine if a day has elapsed</li>
<li>Ruby and Sapphire have a flaw in this day number calculation that effectively treats 2000 and 2001 as the same year (+0 days)</li>
</ul>
<p>An interesting observation here is that any cartridge that hasn't had its battery replaced (and still works) is safe - but it's not a very good idea, considering that if you do replace the battery after beginning a new save, you will have to wait the difference between Jan 1, 2000 and the date of your last save in order for daily events to work again. If you truly would like to play Ruby or Sapphire on a game cartridge these days, it would be best to replace the battery prior to beginning your adventure.</p>
<h1 id="surface-level">Surface Level</h1>
<p>There are a number of ways to fix the bug in any given Ruby or Sapphire cartridge. From <a href="https://bulbapedia.bulbagarden.net/wiki/Berry_glitch#Fixing_the_glitch">Bulbapedia</a>, you can patch via Pokémon FireRed, LeafGreen, Emerald, Pokémon Colosseum/XD, Pokémon Channel (PAL only), Pokémon Box, e-Reader (Japan only), a GameCube Demo exclusive to retailers, a GBA cartridge exclusive to retailers, or, finally, sending your cartridge directly to Nintendo, a service which they discontinued in 2012. I'd like to take a look at the patch provided by Pokémon Emerald, see how it works, why it works, and what it does in different scenarios.</p>
<h2 id="getting-an-emulator-ready">Getting an Emulator Ready</h2>
<p>There are a number of modern emulators with high accuracy and functionality that mimic what's required to perform the Berry Patch, or &quot;Berry Program Update&quot;, as Nintendo/Game Freak call it (I will refer to it as Berry Patch from here on). I attempted to perform the update with VisualBoyAdvance, but I could not get the emulator to transfer the Berry Patch to the 2nd emulated GBA. Thankfully, this did work on the mGBA emulator. The steps are as follows:</p>
<ul>
<li>Obtain mGBA. I used 0.10.5</li>
<li>Obtain a GBA BIOS file. This is required, as the berry program transfers during the GBA BIOS startup. Set the BIOS file in mGBA</li>
<li>Start mGBA, and select &quot;File &gt; New multiplayer window&quot;, which will open a new window</li>
<li>In the original window, start Pokémon FireRed/LeafGreen/Emerald</li>
<li>In the second window, start Pokémon Ruby/Sapphire</li>
<li>Let both games get to the title screen</li>
<li>On Emerald, press SELECT + B at the same time. You can press A through the rest of the screens</li>
<li>On Ruby, press START + SELECT and hold them down, then press CTRL + R (or your Reset hotkey) while still holding down START + SELECT</li>
<li>FR/LG/E should be showing a &quot;transmitting&quot; screen, and R/S should be showing a flashing Nintendo logo beneath the GAME BOY text</li>
<li>Finally, R/S should show text stating &quot;The Berry Program Update will now begin...&quot;</li>
</ul>
<p>It's important to note that your save slot depends on which &quot;player&quot; your emulator is. When you open a multiplayer window in mGBA, &quot;player 1&quot; is the first window, and &quot;player 2&quot; is the second. These are different save slots. If you open mGBA, run through the opening scene, save, and then perform the above steps, your save file will only be recognized by the mGBA that is actually running FR/LG/E at the time. The second mGBA instance (player 2) will not recognize a save file at all.</p>
<p>So what are the different scenarios?</p>
<table>
<thead>
<tr>
<th>Save Date</th>
<th>RTC Date of Patching</th>
<th>Berry Patch Output</th>
<th>RTC Date Set To</th>
</tr>
</thead>
<tbody>
<tr>
<td>No Save</td>
<td>N/A</td>
<td>&quot;Unable to update Berry Program.&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-01-01 (1)</td>
<td>2000-01-01 (1)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-01-01 (1)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>2000-06-01 (153)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-06-02 (153)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>2001-06-01 (152)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td>N/A</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>2000-03-01 (61)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-03-02 (61)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>2001-03-01 (60)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td>N/A</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>2000-01-15 (15)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-01-15 (15)</td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>2000-01-15 (15)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-01-15 (15)</td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>2001-01-10 (10)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td>N/A</td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>2001-01-15 (15)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>2001-01-20 (20)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>2000-12-15 (350)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2001-12-16 (350)</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>2000-12-31 (366)</td>
<td>&quot;Your Berry Program has been updated.&quot;</td>
<td>2002-01-01 (732)</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>2001-01-01 (1)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td>N/A</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>2001-01-15 (15)</td>
<td>&quot;There is no need to update your Berry Program.&quot;</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<p><em>Note that the day value next to the date is how the code in Pokémon Ruby interprets the date into a single number, as described above.</em></p>
<p>I think I've seen enough. Honestly, it looks like a basic update, where <code>if year == 2000: day += 366</code>. This is surprising to me, as Bulbapedia claims:</p>
<blockquote>
<p>If the game is already affected by the Berry glitch, these programs will set the RTC forward to January 2, 2002, the date at which all effects of the glitch end.</p>
</blockquote>
<p>Does the fix check for active berries or something? If it does, why does it update saves in 2000 to 2001? If it doesn't, then why doesn't it update 2001 saves with a lower day value to some later date? These last few scenarios are really surprising to me. You're telling me I could get into a situation where I saved ~360 days into a game's RTC becoming active, and if I don't apply the Berry Patch within the next <em>few weeks</em>, I'm locked out of berry events for almost a year? Even with the &quot;fix&quot;? And why did we never observe the &quot;January 1st, 2002&quot; behavior Bulbapedia described? Now I'm really interested.</p>
<h1 id="hm08-ing-deeper">HM08'ing Deeper</h1>
<p>There's a few things I neglected to explain above, because anything from here on out is going to get far more technical.</p>
<p>In order to actually investigate this, I've been using the mGBA emulator. At first, I was very curious as to how this fix worked. When I heard about it initially, I was thinking there was some kind of binary patch applied to the game to actually fix the logic. The above references to Bulbapedia cleared that up immediately, though, and specified that the fix took place by modifying the real-time clock on the game cartridge itself. When it comes down to it, a lot of games didn't use a real-time clock. The ones that did surely didn't often, if ever, set that real-time clock. For example, when you set the clock upstairs at your house in R/S/E, the game simply uses that as a baseline for future timed events like Shoal Cave which rely on a specific time of day; it doesn't set the RTC's time to the provided value.</p>
<p>So as an emulator developer, what makes the most sense? Do you emulate the bespoke behavior of starting at 2000-01-01 and counting up indefinitely from there somehow like a real cartridge would? Or do you just use... the real-time clock... built into the device you're running the emulator on? Let's say you're using the user's computer as the source for the RTC. What happens when a game writes to the RTC? You obviously can't (or shouldn't) write to the user's computer's date and time. mGBA handles this by ignoring RTC writes entirely.</p>
<p>While mGBA does have custom RTC settings that I could use, I only learned about them after writing this entire post. So I used a great piece of software called RunAsDate which runs a program as if it's a certain date you specify, which works as expected on mGBA. Now that I can save on certain days and run the Berry Patch on others, the next thing we need is a way to figure out how to see what the Berry Patch is doing to the RTC.</p>
<p>Many hours, one S3511A datasheet, many comments to ensure I'm still sane, a few changes and a lot of logging later, I have some adjustments to the mGBA source that will log input commands just as it logs output commands:</p>
<!-- mGBA Diff -->
<pre class="language-diff" tabindex="0"><code class="language-diff">index eb5328346..fff5d3b03 100644
<span class="token coord">--- a/src/gba/cart/gpio.c</span>
<span class="token coord">+++ b/src/gba/cart/gpio.c</span>
@@ -137,42 +137,59 @@ void _outputPins(struct GBACartridgeHardware* hw, unsigned pins) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>
<span class="token prefix unchanged"> </span>void _rtcReadPins(struct GBACartridgeHardware* hw) {
<span class="token prefix unchanged"> </span>       // Transfer sequence:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       //   SCK SIO  CS
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>       // P: 0 | 1 |  2 | 3
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       // == Initiate
<span class="token prefix deleted">-</span>       // > HI | - | LO | -
<span class="token prefix deleted">-</span>       // > HI | - | HI | -
<span class="token prefix deleted">-</span>       // == Transfer bit (x8)
<span class="token prefix deleted">-</span>       // > LO | x | HI | -
<span class="token prefix deleted">-</span>       // > HI | - | HI | -
<span class="token prefix deleted">-</span>       // &lt; ?? | x | ?? | -
<span class="token prefix deleted">-</span>       // == Terminate
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       // == Initiate - step 0, CS lo -> hi
<span class="token prefix inserted">+</span>       // > HI | - | LO | - | 1
<span class="token prefix inserted">+</span>       // > HI | - | HI | - | 5
<span class="token prefix inserted">+</span>
<span class="token prefix inserted">+</span>       // == Transfer bit (x8) - step 1, SCK lo -> hi
<span class="token prefix inserted">+</span>       // > LO | x | HI | - | 4 = 0 bit, 6 = 1 bit
<span class="token prefix inserted">+</span>       // > HI | - | HI | - | 5
<span class="token prefix inserted">+</span>       // &lt; ?? | x | ?? | - |
<span class="token prefix inserted">+</span>
<span class="token prefix inserted">+</span>       // == Terminate - CS low
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>       // >  - | - | LO | -
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>       switch (hw->rtc.transferStep) {
<span class="token prefix unchanged"> </span>       case 0:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               // SCK HI
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               if ((hw->pinState &amp; 5) == 1) {
<span class="token prefix unchanged"> </span>                       hw->rtc.transferStep = 1;
<span class="token prefix unchanged"> </span>               }
<span class="token prefix unchanged"> </span>               break;
<span class="token prefix unchanged"> </span>       case 1:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               // SCK, CS HI
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               if ((hw->pinState &amp; 5) == 5) {
<span class="token prefix unchanged"> </span>                       hw->rtc.transferStep = 2;
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               // CS LO - abort
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               } else if ((hw->pinState &amp; 5) != 1) {
<span class="token prefix unchanged"> </span>                       hw->rtc.transferStep = 0;
<span class="token prefix unchanged"> </span>               }
<span class="token prefix unchanged"> </span>               break;
<span class="token prefix unchanged"> </span>       case 2:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               // if SCK lo - read bit
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               if (!(hw->pinState &amp; 1)) {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       // empty the msb we haven't yet read
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       hw->rtc.bits &amp;= ~(1 &lt;&lt; hw->rtc.bitsRead);
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>
<span class="token prefix inserted">+</span>                       // read the new bit from SIO and shift it into the correct position
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       hw->rtc.bits |= ((hw->pinState &amp; 2) >> 1) &lt;&lt; hw->rtc.bitsRead;
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>               // if SCK hi -
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               } else {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       // CS hi, communication is not done
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       if (hw->pinState &amp; 4) {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                               // the current command is a write command OR command is not set
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                               if (!RTCCommandDataIsReading(hw->rtc.command)) {
<span class="token prefix unchanged"> </span>                                       ++hw->rtc.bitsRead;
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>                                       if (hw->rtc.bitsRead == 8) {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                                       if (hw->rtc.bitsRead % 8 == 0) {
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                                               _rtcProcessByte(hw);
<span class="token prefix unchanged"> </span>                                       }
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                               // the command is a read command
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                               } else {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                                       // set output pins for game to read
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                                       _outputPins(hw, 5 | (_rtcOutput(hw) &lt;&lt; 1));
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                                       ++hw->rtc.bitsRead;
<span class="token prefix unchanged"> </span>                                       if (hw->rtc.bitsRead == 8) {
<span class="token prefix unchanged"> </span>                                               --hw->rtc.bytesRemaining;
</span>@@ -183,6 +200,7 @@ void _rtcReadPins(struct GBACartridgeHardware* hw) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>                                               hw->rtc.bitsRead = 0;
<span class="token prefix unchanged"> </span>                                       }
<span class="token prefix unchanged"> </span>                               }
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       // CS lo - we are done, clean up
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       } else {
<span class="token prefix unchanged"> </span>                               hw->rtc.bitsRead = 0;
<span class="token prefix unchanged"> </span>                               hw->rtc.bytesRemaining = 0;
</span>@@ -206,7 +224,7 @@ void _rtcProcessByte(struct GBACartridgeHardware* hw) {

<span class="token unchanged"><span class="token prefix unchanged"> </span>                       hw->rtc.bytesRemaining = RTC_BYTES[RTCCommandDataGetCommand(command)];
<span class="token prefix unchanged"> </span>                       hw->rtc.commandActive = hw->rtc.bytesRemaining > 0;
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>                       mLOG(GBA_HW, DEBUG, "Got RTC command %x", RTCCommandDataGetCommand(command));
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       mLOG(GBA_HW, DEBUG, "Got RTC command %x %x | bits: %04X", RTCCommandDataGetCommand(command), RTCCommandDataGetReading(command), hw->rtc.bits);
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       switch (RTCCommandDataGetCommand(command)) {
<span class="token prefix unchanged"> </span>                       case RTC_RESET:
<span class="token prefix unchanged"> </span>                               hw->rtc.control = 0;
</span>@@ -228,11 +246,13 @@ void _rtcProcessByte(struct GBACartridgeHardware* hw) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>                       hw->rtc.control = hw->rtc.bits;
<span class="token prefix unchanged"> </span>                       break;
<span class="token prefix unchanged"> </span>               case RTC_FORCE_IRQ:
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>                       mLOG(GBA_HW, STUB, "Unimplemented RTC command %u", RTCCommandDataGetCommand(hw->rtc.command));
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       mLOG(GBA_HW, STUB, "Unimplemented RTC command FORCE_IRQ");
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       break;
<span class="token prefix unchanged"> </span>               case RTC_RESET:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       mLOG(GBA_HW, STUB, "Unimplemented RTC command RESET");
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>               case RTC_DATETIME:
<span class="token prefix unchanged"> </span>               case RTC_TIME:
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>                       mLOG(GBA_HW, STUB, "RTC command %02X input byte %02X", RTCCommandDataGetCommand(hw->rtc.command), hw->rtc.bits);
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>                       break;
<span class="token prefix unchanged"> </span>               }
<span class="token prefix unchanged"> </span>       }
</span></code></pre>
<p>You'll notice that the only substantial changes here are a lot of comments for my understanding (I'm not a hardware guy...) and the handler for <code>RTC_TIME</code> in <code>_rtcProcessByte</code>. I am not sure if my change to <code>if (hw-&gt;rtc.bitsRead % 8 == 0) {</code> is necessary, but it made sense at the time... I think.</p>
<p>Anyways, now we get some nice output when the Berry Patch attempts to adjust the realtime clock:</p>
<!-- Original (read operation) -->
<pre><code>[DEBUG] GBA Pak Hardware:	Got RTC command 2 1 | bits: 00A6
[DEBUG] GBA Pak Hardware:	RTC output byte 00
[DEBUG] GBA Pak Hardware:	RTC output byte 12
[DEBUG] GBA Pak Hardware:	RTC output byte 31
[DEBUG] GBA Pak Hardware:	RTC output byte 00
[DEBUG] GBA Pak Hardware:	RTC output byte 00
[DEBUG] GBA Pak Hardware:	RTC output byte 00
[DEBUG] GBA Pak Hardware:	RTC output byte 49
</code></pre>
<!-- New (write operation) -->
<pre><code>[DEBUG] GBA Pak Hardware:	Got RTC command 2 0 | bits: 0026
[STUB] GBA Pak Hardware:	RTC command 02 input byte 02
[STUB] GBA Pak Hardware:	RTC command 02 input byte 01
[STUB] GBA Pak Hardware:	RTC command 02 input byte 01
[STUB] GBA Pak Hardware:	RTC command 02 input byte 00
[STUB] GBA Pak Hardware:	RTC command 02 input byte 00
[STUB] GBA Pak Hardware:	RTC command 02 input byte 00
[STUB] GBA Pak Hardware:	RTC command 02 input byte 49
</code></pre>
<p><em>By the way, if you're trying to build mGBA, just <a href="https://github.com/mgba-emu/mgba#docker-building">build it in Docker</a>. Save yourself.</em></p>
<p>You can see this is from the above example, running the berry program on 2000-12-31, which set the date to 2002-01-01. The RTC uses a single byte for the year. That means it stores only the years since 2000, so 2000 is 00 and 2001 is 01. There's only one more thing to do, which is examine the day value code to see how the game determines the single value to store to determine if a day has passed. It's Ghidra time! Using the wonderful <a href="https://github.com/pudii/gba-ghidra-loader">GBA Loader</a> Ghidra plugin, we can pop open the ROM files for the games without having to do a lot of manual stuff to get it to analyze properly. Once analysis is done, we only really have one problem. Where do we look?</p>
<h2 id="i-m-not-cheating-i-m-just-setting-my-rtc-forward">I'm Not Cheating, I'm Just Setting My RTC Forward</h2>
<p>If you haven't noticed yet, the steps I'm writing aren't necessarily in the order I did them or researched them. In fact, the very first thing I did was what I'm about to describe. The first thing I wanted to look at once I learned the &quot;berry update program&quot; simply adjusted the real-time clock was compare the v1.1 and v1.2 ROM files for Ruby to see what the actual code fix involved. Doing just that, we get the following:</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/16ilCVnzrz-1855.avif 1855w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/16ilCVnzrz-1855.webp 1855w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/16ilCVnzrz-1855.png" alt="A comparison of the 1.1 and 1.2 Pokémon Ruby ROM files in a hex editor" width="1855" height="1235"></picture></p>
<p>Okay, 3 differences, 2 bytes near the beginning, then a huge chunk of the same content, then two single-byte differences 35 bytes apart from each other. The beginning bytes are likely a game version. The two changes later are likely what we're after. Let's go to that address in Ghidra in each ROM. The executable section seems to start at 0x8000000, and our differences start at +0x919B. Let's go to 0x800919B.</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/iKcZJC6IuH-2023.avif 2023w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/iKcZJC6IuH-2023.webp 2023w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/iKcZJC6IuH-2023.png" alt="Ghidra, showing the disassembly of both 1.1 and 1.2 ROMs." width="2023" height="957"></picture></p>
<p>See it? The only two changes? Yep. Two branch conditions. Two incorrect branch conditions caused Game Freak to have to produce this patching code, put it into as many places as they could and also ship a new revision of the game cartridge to fix. Two branch conditions. But what do they do? Let's look at the function:</p>
<!-- rtcDateToDayValue -->
<pre class="language-c" tabindex="0"><code class="language-c">ulonglong <span class="token function">rtcDateToDayValue</span><span class="token punctuation">(</span>uint year<span class="token punctuation">,</span> uint month<span class="token punctuation">,</span> uint day<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> leap<span class="token punctuation">;</span>
  <span class="token keyword">int</span> monthIndex<span class="token punctuation">;</span>
  dword currentMonthMaxDays<span class="token punctuation">;</span>
  dword <span class="token operator">*</span>monthDaysPtr<span class="token punctuation">;</span>
  uint yearToDays<span class="token punctuation">;</span>
  uint yearVal<span class="token punctuation">;</span>
  
  yearToDays <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  yearVal <span class="token operator">=</span> year<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>yearVal <span class="token operator">=</span> yearVal <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>yearVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    yearToDays <span class="token operator">=</span> yearToDays <span class="token operator">+</span> <span class="token number">365</span><span class="token punctuation">;</span>
    leap <span class="token operator">=</span> <span class="token function">isLeapYear</span><span class="token punctuation">(</span>yearVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>leap <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      yearToDays <span class="token operator">=</span> yearToDays <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// S3511 has jan as month 1</span>
  monthIndex <span class="token operator">=</span> month <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// accumulate days in previous months</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>monthIndex <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    monthDaysPtr <span class="token operator">=</span> daysPerMonth<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      currentMonthMaxDays <span class="token operator">=</span> <span class="token operator">*</span>monthDaysPtr<span class="token punctuation">;</span>
      monthDaysPtr <span class="token operator">=</span> monthDaysPtr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      yearToDays <span class="token operator">=</span> yearToDays <span class="token operator">+</span> currentMonthMaxDays<span class="token punctuation">;</span>
      monthIndex <span class="token operator">=</span> monthIndex <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>monthIndex <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// if current year is a leap year and we're past feb 29th</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>month <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>leap <span class="token operator">=</span> <span class="token function">isLeapYear</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">,</span> leap <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    yearToDays <span class="token operator">=</span> yearToDays <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> yearToDays <span class="token operator">+</span> day<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>I've cleaned up this function with proper variable and function labels. Assuming <code>daysPerMonth</code> is an array with the number of days in each month and <code>isLeapYear</code> functions properly, this function will give you the number of days since 0, 0, 0. Unless... your year is 1!</p>
<!-- Broken year condition -->
<pre class="language-C" tabindex="0"><code class="language-C">while (yearVal = yearVal - 1, 0 < (int)yearVal) {</code></pre>
<p>If the year is 2001, the function receives <code>1</code> for the year. It immediately subtracts 1 from it and only processes the year's days if it's still greater than 0, resulting in both 2000 and 2001 adding zero days from this block of code. How did Game Freak fix this in the revised ROM?</p>
<!-- Fixed year condition -->
<pre class="language-C" tabindex="0"><code class="language-C">while (yearVal = yearVal - 1, -1 < (int)yearVal) {</code></pre>
<p>Well. That works.</p>
<p>Anyways, given this code, we now have the three things we needed to create the table all the way up in the first part of this post. We can save on specific days, apply the patch on specific days, see what the RTC is being set to, and we can accurately determine the day value for any given day. That's everything that brought us to where we are and allowed us to observe the odd behavior of the patch in the table above. What's next?</p>
<h1 id="the-berry-patch">The Berry Patch</h1>
<p>I think the next step will have to be analyzing the Berry Patch code and check its decision logic to see how it decides when and how far to move the RTC forward. The first step to analyzing the Berry Patch ROM is, well, finding the ROM. Since the Berry Patch is not its own cartridge that you plug into the GBA, getting our hands on it for analysis is not going to be straightforward.</p>
<p>There are two ways I can think of to obtain the Berry Patch ROM. One is analyzing the data sent over the link cable during boot when running the Berry Patch on the Pokémon Ruby emulator. Even if we did log everything coming over the wire, not only is there a lot of data, but there's likely a lot of communication protocol cruft that we don't need and will be a pain to sift through. The other method is via analyzing the Pokémon Emerald ROM. It has to be in there somewhere, and it's likely much easier to do compared to the link cable method. Let's try and find it that way.</p>
<p>The Ghidra GBA Loader plugin linked above mentions a resource for GBA documentation, <a href="https://problemkaputt.de/gbatek.htm">GBATEK</a>. We know that we're transmitting executable code over the link cable from system A to system B. System A is running a game and system B is in the BIOS. GBATEK has a full section on GBA BIOS functions, of which there's an entry called &quot;BIOS Multi Boot (Single Game Pak)&quot; which describes a process by which the GBA can boot a game over the link cable. That sounds like what we're looking for.</p>
<p><strong>Note: I've adjusted some terms in quotes from GBATEK to adhere to more modern terminology. The terms Leader/Follower will be used from here on.</strong></p>
<blockquote>
<p>SWI 25h (GBA) - MultiBoot<br>
This function uploads &amp; starts program code to follower GBAs, allowing to launch programs on follower units even if no cartridge is inserted into the followers (this works because all GBA BIOSes contain built-in download procedures in ROM).<br>
However, the SWI 25h BIOS upload function covers only 45% of the required Transmission Protocol, the other 55% must be coded in the leader cartridge (see Transmission Protocol below).<br>
r0  Pointer to MultiBootParam structure<br>
r1  Transfer Mode (undocumented)<br>
0=256KHz, 32bit, Normal mode    (fast and stable)<br>
1=115KHz, 16bit, MultiPlay mode (default, slow, up to three followers)<br>
2=2MHz,   32bit, Normal mode    (fastest but maybe unstable)<br>
Note: HLL-programmers that are using the MultiBoot(param_ptr) macro cannot specify the transfer mode and will be forcefully using MultiPlay mode.<br>
Return:<br>
r0  0=okay, 1=failed</p>
</blockquote>
<p>We can likely start this by looking through Emerald's ROM for SWI 25h - the software interrupt opcode with immediate argument 0x25. Unfortunately, after searching through all 900+ software interrupt references in the Emerald ROM, I could not find any referencing SWI 0x25. Which is odd, isn't it? Seeing how that didn't quite work, I think I will use the following table from GBATEK to search for some communication primitives:</p>
<h4 id="required-transfer-initiation-in-leader-program">Required Transfer Initiation in leader program</h4>
<table>
<thead>
<tr>
<th>Times</th>
<th>Send</th>
<th>Receive</th>
<th>Expl.</th>
</tr>
</thead>
<tbody>
<tr>
<td>...</td>
<td>6200</td>
<td>FFFF</td>
<td>Follower not in multiplay/normal mode yet</td>
</tr>
<tr>
<td>1</td>
<td>6200</td>
<td>0000</td>
<td>Follower entered correct mode now</td>
</tr>
<tr>
<td>15</td>
<td>6200</td>
<td>720x</td>
<td>Repeat 15 times, if failed: delay 1/16s and restart</td>
</tr>
<tr>
<td>1</td>
<td>610y</td>
<td>720x</td>
<td>Recognition okay, exchange leader/follower info</td>
</tr>
<tr>
<td>60h</td>
<td>xxxx</td>
<td>NN0x</td>
<td>Transfer C0h bytes header data in units of 16bits</td>
</tr>
<tr>
<td>1</td>
<td>6200</td>
<td>000x</td>
<td>Transfer of header data completed</td>
</tr>
<tr>
<td>1</td>
<td>620y</td>
<td>720x</td>
<td>Exchange leader/follower info again</td>
</tr>
<tr>
<td>...</td>
<td>63pp</td>
<td>720x</td>
<td>Wait until all followers reply 73cc instead 720x</td>
</tr>
<tr>
<td>1</td>
<td>63pp</td>
<td>73cc</td>
<td>Send palette_data and receive client_data[1-3]</td>
</tr>
<tr>
<td>1</td>
<td>64hh</td>
<td>73uu</td>
<td>Send handshake_data for final transfer completion</td>
</tr>
</tbody>
</table>
<p>Aaaaaaaand nothing. What? Well, here's where we learn about the processor inside the GBA.</p>
<blockquote>
<p>The two CPU states<br>
As mentioned above, two CPU states exist:<br>
ARM state: Uses the full 32bit instruction set (32bit opcodes)<br>
THUMB state: Uses a cutdown 16bit instruction set (16bit opcodes)<br>
Regardless of the opcode-width, both states are using 32bit registers, allowing 32bit memory addressing as well as 32bit arithmetic/logical operations.</p>
</blockquote>
<blockquote>
<p>Combining ARM and THUMB state<br>
Switching between ARM and THUMB state is done by a normal branch (BX) instruction which takes only a handful of cycles to execute (allowing to change states as often as desired - with almost no overload).</p>
</blockquote>
<p>I'm under the impression that Ghidra is misinterpreting a number of instructions here as different modes, as the opcode width changes as well as the opcodes themselves:</p>
<!-- THUMB Binary Opcode Format -->
<pre><code>Form|_15|_14|_13|_12|_11|_10|_9_|_8_|_7_|_6_|_5_|_4_|_3_|_2_|_1_|_0_|
...
_17_|_1___1___0___1___1___1___1___1_|___________User_Data___________|SWI
...
</code></pre>
<!-- ARM Binary Opcode Format -->
<pre><code>|..3 ..................2 ..................1 ..................0|
|1_0_9_8_7_6_5_4_3_2_1_0_9_8_7_6_5_4_3_2_1_0_9_8_7_6_5_4_3_2_1_0|
...
|_Cond__|1_1_1_1|_____________Ignored_by_Processor______________| SWI
...
</code></pre>
<p>Unfortunately I couldn't actually find any way to handle this properly in Ghidra, so I had to switch to IDA from here on out.</p>
<p>Looking for the above &quot;SWI 0x25&quot;, it seems IDA recognizes SWI as &quot;SVC&quot;, which is close enough, I guess? We have 2 references to it in the Emerald ROM, with only one of those in executable code:</p>
<!-- SVC 0x25 Call -->
<pre><code>ROM:082E7094 sub_82E7094:                            @ CODE XREF: sub_81BA70C+2F2↑p
ROM:082E7094                 MOVS    R1, #1
ROM:082E7096                 SVC     0x25 @ '%'
ROM:082E7098                 BX      LR
</code></pre>
<p>Oooh! Remember the SWI docs? It's clearly putting <code>1</code> into R1 to set the transfer mode before invoking the multiboot BIOS function. I named this &quot;invokeMultiboot&quot; and checked the calling function to see if there was anything interesting in there - and I see multiboot protocol primitives and SIO addresses! The entire function seems to be responsible for handling the multiboot negotiation. Checking the calling function of that, we get an interesting construct:</p>
<!-- Multiboot handling switch statement -->
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
      <span class="token function">sub_81BF5A4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span> <span class="token operator">||</span> <span class="token punctuation">(</span>word_30022EE <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>word_30022EE <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      v2 <span class="token operator">=</span> dword_30012B8<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">44</span><span class="token punctuation">)</span> <span class="token operator">=</span> dword_89A6550<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token number">79</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">sub_81BA6D0</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
      <span class="token function">multibootCommsHandler</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> dword_30012B8<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x20200</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x20200</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      v4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> v4<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0xB4u</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      <span class="token function">sub_81BAB6C</span><span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dword_89A660C<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_89AA144 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_89A660C<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      <span class="token function">multibootCommsHandler</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BAC30</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
        v1 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
        v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_30012B8 <span class="token operator">+</span> <span class="token number">34</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
          <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
        v1 <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
LABEL_27<span class="token operator">:</span>
      <span class="token operator">*</span>v0 <span class="token operator">=</span> v1<span class="token punctuation">;</span>
      <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>word_30022EE <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token function">sub_80008F4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">sub_81BF7A4</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token operator">||</span> <span class="token punctuation">(</span>word_30022EE <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
      v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dword_30012B8<span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_27<span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> v6<span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
<p>Following the statements at <code>LABEL_27</code>, this code looks like it's stepping through the cases as steps in order. It has a region of memory whose address is in IRAM. I have no clue why it runs the multiboot function twice at this point. Rather than trying to follow the execution of this function, we know that the ROM header sent to the secondary system is placed at 0x20 in the multiboot parameter, so let's follow the parameter passed to SWI 0x25 up through its callers and see where that gets set.</p>
<p>After many hours of fussing around with the <code>multibootProcessor</code> and <code>multibootCommunicationHandler</code> as I call it, I could not find anywhere where the <code>boot_srcp</code> or <code>boot_endp</code> are set, which seems to tell SWI 0x25 where to copy the actual program to boot from. I also could not find any location where the header data described on GBATEK is copied. I was <em>about</em> to give up with this strategy since I spent so much time on it. But I realized that, since I figured out that <code>dword_30012B8 + 4</code> is the <code>multibootParam</code> structure described on GBATEK, I could go to the <code>multibootProcessor</code>and check every function that receives that parameter for references to <code>+0x20</code> or <code>+0x24</code> (the <code>boot_srcp</code> and <code>boot_endp</code>, respectively). And wouldn't you know it, a function I completely originally ignored was the function setting these fields:</p>
<!-- multibootSetCopyRegion -->
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">int</span> __fastcall <span class="token function">multibootSetCopyRegion</span><span class="token punctuation">(</span>multibootParam <span class="token operator">*</span>multibootParam<span class="token punctuation">,</span> <span class="token keyword">int</span> romSrc<span class="token punctuation">,</span> <span class="token keyword">int</span> romLenMin15<span class="token punctuation">,</span> <span class="token keyword">char</span> a4<span class="token punctuation">,</span> <span class="token keyword">int</span> a5<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> v7<span class="token punctuation">;</span> <span class="token comment">// r3</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> romLen<span class="token punctuation">;</span> <span class="token comment">// r2</span>
  <span class="token keyword">char</span> v9<span class="token punctuation">;</span> <span class="token comment">// r3</span>
  <span class="token keyword">char</span> v10<span class="token punctuation">;</span> <span class="token comment">// r0</span>
  <span class="token keyword">int</span> v12<span class="token punctuation">;</span> <span class="token comment">// [sp+10h] [bp-4h]</span>

  v7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> multibootParam<span class="token operator">-></span>multiboot_state
    <span class="token operator">||</span> <span class="token operator">!</span>multibootParam<span class="token operator">-></span>client_bit
    <span class="token operator">||</span> multibootParam<span class="token operator">-></span>unknown3<span class="token punctuation">[</span><span class="token number">34</span><span class="token punctuation">]</span>
    <span class="token operator">||</span> <span class="token punctuation">(</span>multibootParam<span class="token operator">-></span>boot_srcp <span class="token operator">=</span> romSrc<span class="token punctuation">,</span> romLen <span class="token operator">=</span> <span class="token punctuation">(</span>romLenMin15 <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFF0</span><span class="token punctuation">,</span> romLen <span class="token operator">-</span> <span class="token number">256</span> <span class="token operator">></span> <span class="token number">0x3FF00</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">resetMultibootParam</span><span class="token punctuation">(</span>multibootParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    multibootParam<span class="token operator">-></span>boot_endp <span class="token operator">=</span> romSrc <span class="token operator">+</span> romLen<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a5 <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x4000000</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">24</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        v9 <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> a4<span class="token punctuation">;</span>
        v10 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">-</span> a5<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_10<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        v10 <span class="token operator">=</span> <span class="token number">56</span><span class="token punctuation">;</span>
        v9 <span class="token operator">=</span> a4<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_10<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
        v9 <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> a4<span class="token punctuation">;</span>
        v10 <span class="token operator">=</span> a5 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
LABEL_10<span class="token operator">:</span>
        v7 <span class="token operator">=</span> v9 <span class="token operator">|</span> v10<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    multibootParam<span class="token operator">-></span>palette_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>v7 <span class="token operator">&amp;</span> <span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x81</span><span class="token punctuation">;</span>
    multibootParam<span class="token operator">-></span>multiboot_state <span class="token operator">=</span> <span class="token number">0xD0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> v12<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We can get the ROM ptr from the parameters. What are they?</p>
<!-- multibootSetCopyRegion call -->
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token function">multibootSetCopyRegion</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                       <span class="token comment">// multibootParam</span>
        <span class="token operator">&amp;</span>dword_89A660C<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                              <span class="token comment">// boot_srcp</span>
        dword_89AA144 <span class="token operator">-</span> <span class="token operator">&amp;</span>dword_89A660C<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment">// romLenMin15</span>
        <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Awesome! What's at <code>&amp;dword_89A660C[1]</code>? That's 4 bytes after <code>0x89A660C</code>, so:</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/GF27F1l3oO-903.avif 903w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/GF27F1l3oO-903.webp 903w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/GF27F1l3oO-903.png" alt="A section of memory in the Emerald ROM dump, showing what looks to be a sub-ROM." width="903" height="1323"></picture></p>
<p>That sure looks like a ROM! It looks like it starts <em>after</em> what looks to be a ROM header, but remember, the ROM header is transferred before <code>SWI 0x25</code> is invoked. If we head back to IDA and go backwards a bit, we can actually see a reference to... oh.</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/G1X2c7GJpC-930.avif 930w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/G1X2c7GJpC-930.webp 930w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/G1X2c7GJpC-930.png" alt="A section of memory in IDA showing a reference to 89A660C as described above, but another reference to what looks like a ROM header, C0 bytes before it with xrefs from the multibootProcessor function." width="930" height="461"></picture></p>
<p>Let's bring this ROM into a new file and throw it into IDA or Ghidra and see what we can find!</p>
<h1 id="preparing-to-analyze-the-sub-rom">Preparing to Analyze the Sub-ROM</h1>
<p>When we open the patch program in IDA, we get something unexpected (or... expected?). It only recognizes a few functions, and they aren't correct either.</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/8VmscCP7Mh-475.avif 475w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/8VmscCP7Mh-475.webp 475w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/8VmscCP7Mh-475.png" alt="4 functions in IDA, start, sub_8000100, sub_8000120, and sub_800014C with a size of 0x30094" width="475" height="129"></picture></p>
<p>As you might have guessed, since we're not running from a Game Pak, our entrypoint and ROM base address isn't 0x8000000 anymore. Our multiboot image has been copied to external work RAM on the GBA board (outside of the CPU). Not only is this why our ROM isn't analyzed properly, it's also the reason there's a 256kb limit on the size of the multiboot image - there's only 256kb of this RAM available. This is the reason for the size check on <code>romLen</code> in the <code>multibootSetCopyRegion</code> function we saw earlier. Let's see if we can modify the GBA loader for IDA to analyze this ROM properly.</p>
<p>Even after setting the entrypoint appropriately to the beginning of external work RAM, we still get this odd analysis. To make matters even worse, we're in the dark with decompilation - the code we're booting appears to be THUMB, which IDA can't decompile. In the few instructions I do see though, there's a construct that might give us a path forward.</p>
<!-- Berry Patch assembly -->
<pre class="language-asm" tabindex="0"><code class="language-asm">WRAM:20001A0 loc_20001A0:                            @ CODE XREF: sub_200014C:loc_20001A0↓j
WRAM:20001A0                                         @ sub_200014C+5C↓j ...
WRAM:20001A0                 Bne             loc_20001A0
WRAM:20001A4                 CMP             R1, R2
WRAM:20001A8                 Bne             loc_20001A0
WRAM:20001AC                 LDRH            R2, [R3,#2]
WRAM:20001B0                 STRH            R2, [R0,#0xA]
WRAM:20001B4                 BL              sub_2000120
WRAM:20001B8                 Bne             loc_20001A0
WRAM:20001BC                 CMP             R1, R2
WRAM:20001C0                 Bne             loc_20001A0
WRAM:20001C4                 MOV             R1, #0
WRAM:20001C8                 STRH            R1, [R0,#0xA]
WRAM:20001CC                 LDR             R0, =unk_20002F0
WRAM:20001D0                 LDR             R1, =loc_2010000
WRAM:20001D4                 SVC             0x110000
WRAM:20001D8                 LDR             LR, =loc_2010000
WRAM:20001DC                 BX              LR @ loc_2010000</code></pre>
<p>Remember SVC? This is THUMB code, so the weird-looking immediate for the SVC is actually just 0x11. What is <code>SWI 0x11</code>? It's <code>LZ77UnCompReadNormalWrite8bit</code>, reading data from <code>0x20002F0</code>, decompressing it, writing it to <code>0x2010000</code>, and then branching right there. After finding a <a href="https://github.com/lunasorcery/gba-lz77">wonderful tool</a>, we can copy everything from <code>0x20002F0</code> to the end of the &quot;ROM&quot; into a new file, decompress it, then place this data back into said &quot;ROM&quot; at <code>0x2010000</code> and re-analyze it!</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/VOvtygzpyG-1419.avif 1419w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/VOvtygzpyG-1419.webp 1419w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/VOvtygzpyG-1419.png" alt="IDA view of the Berry Patch ROM, showing not just 3 functions but many more." width="1419" height="974"></picture></p>
<p>There we go! We can now take a look and analyze the code of the Berry Patch itself. Since IDA won't provide decompilation for this, we'll go back to Ghidra after adjusting the Ghidra GBA Loader plugin to set the entrypoint to <code>0x2000000</code>.</p>
<h1 id="actually-analyzing-the-sub-rom">Actually Analyzing the Sub-ROM</h1>
<p>There's a few things we know already about the Berry Patch:</p>
<ul>
<li>it reads your save data</li>
<li>it reads the RTC</li>
<li>it writes to the RTC (sometimes)</li>
</ul>
<p>Let's start with GPIO access, as I've poked around that enough to establish a basic sense of it. The most likely place to find useful code is in functions that utilize the direction and control registers for GPIO. There's only two places the GPIO control register is used, and 12 places the direction register is used.</p>
<!-- setGPIOReadWrite -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined4 <span class="token function">setGPIOReadWrite</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  undefined4 in_lr<span class="token punctuation">;</span>
  
  GPIO_CNT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> in_lr<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We'll call this <code>setGPIOReadWrite</code> because it sets the control register to 1, which means &quot;R/W mode&quot;. And yes, there is a <code>setGPIOReadOnly</code> function as well - equally as unexciting. On the other hand, if we look at references to the GPIO direction register, we get a handful of functions full of what looks like RTC primitives. Check this out:</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/4dzE1KRkXx-1819.avif 1819w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/4dzE1KRkXx-1819.webp 1819w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/4dzE1KRkXx-1819.png" alt="Three windows, one the Ghidra window showing a function manually named RTCReset, where in the function it sends 0x60 over GPIO. On the bottom is 010 Editor showing that, when parsed as an RTC command, 0x60 is command 0 and is a write command. Finally, on the left is a table of the RTC datasheet showing that command 0 is the reset command." width="1819" height="945"></picture></p>
<p><em>Please forgive my having named variables prior to explaining them. If I wrote about every dead-end before finding the correct path, it would be very boring.</em></p>
<p>In fact, we can take a look at every function that calls <code>sendGPIO</code> and rename the upper function with commands appropriately. Doing this, we now have 8 documented functions:</p>
<ul>
<li><code>RTCReadAlarm1</code>: read alarm 1</li>
<li><code>RTCReadHMS</code>: read hour, minute, second from RTC</li>
<li><code>RTCReadStatus</code>: read status register from RTC</li>
<li><code>RTCReadYMDDOW</code>: read year, month, day, day of week from RTC</li>
<li><code>RTCReset</code>: reset RTC</li>
<li><code>RTCWriteHMS</code>: write hour, minute, second to RTC</li>
<li><code>RTCWriteStatus</code>: write status register to RTC</li>
<li><code>RTCWriteYMDDOW</code>: write year, month, day, day of week to RTC</li>
</ul>
<p>Given we know that the Berry Patch writes the year to the RTC, let's follow that function up... and here we go:</p>
<!-- FUN_02010b2c -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined4 <span class="token function">FUN_02010b2c</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  undefined4 in_lr<span class="token punctuation">;</span>
  
  <span class="token function">FUN_0201074c</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
  iVar1 <span class="token operator">=</span> <span class="token function">FUN_02010558</span><span class="token punctuation">(</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">=</span> <span class="token function">FUN_02010558</span><span class="token punctuation">(</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">,</span> iVar1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iVar1 <span class="token operator">=</span> <span class="token function">FUN_02010558</span><span class="token punctuation">(</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      DAT_03001020 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>         <span class="token comment">// 2002</span>
      DAT_03001021 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">// jan</span>
      DAT_03001022 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>         <span class="token comment">// 2</span>
      <span class="token function">_RTCWriteYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      iVar1 <span class="token operator">=</span> <span class="token function">FUN_02010ae8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">FUN_02010a84</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FUN_02010a44</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">FUN_02010a44</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">_RTCWriteYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_03001020<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> in_lr<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This is what we've been looking for this ENTIRE TIME! The code that determines whether to set the date to Jan 2, 2002, or to increase it by 366 days! Let's clean it up and name some surrounding functions!</p>
<!-- BerryUpdateRTCWrite -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined4 <span class="token function">BerryUpdateRTCWrite</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> val<span class="token punctuation">;</span>
  undefined4 in_lr<span class="token punctuation">;</span>
  
  <span class="token function">RTCReadStatusAndYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
  val <span class="token operator">=</span> <span class="token function">BCDDecode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>g_YMDDOWStore<span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>val <span class="token operator">=</span> <span class="token function">BCDDecode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>g_YMDDOWStore<span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">,</span> val <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if year is 0 or 1 (2000 or 2001)</span>
    val <span class="token operator">=</span> <span class="token function">BCDDecode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>g_YMDDOWStore<span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if year == 1 (2001)</span>
      g_YMDDOWStore<span class="token punctuation">.</span>year <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      g_YMDDOWStore<span class="token punctuation">.</span>month <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      g_YMDDOWStore<span class="token punctuation">.</span>day <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token function">_RTCWriteYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      val <span class="token operator">=</span> <span class="token function">HasLeapDay2000Occurred</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// if the leap day in 2000 has already occurred */</span>
        <span class="token function">rtcIncrementDay</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rtcIncrement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">rtcIncrement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">_RTCWriteYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> in_lr<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This shows exactly what the logic is for actually setting the RTC as part of the Berry Patch. If the year is 1, it just sets the RTC to Jan 2, 2002. If the year is 0, it checks if the leap day has happened in 2000 yet. If it has, it sets the RTC 366 days into the future by incrementing the day and anything else necessary (such as the month or year if the day would surpass the number of days in that month). If the leap day has not happened yet, it just increments the year.</p>
<p>This is all well and good - awesome, actually, including the fact that the calling function seems to be another one of those &quot;handler&quot; type functions with multiple switch cases that progress through to each other. We'll call that function <code>BerryUpdateMain</code> from now on, as we'll see more of it soon. But it doesn't explain the behavior that we observed in the table far above. We'll have to look more into this, as there's still a few mysteries. I think the next thing to check is where the berry update program accesses the save on the Ruby or Sapphire cartridge.</p>
<h2 id="save-file-aside">Save File Aside</h2>
<p>As a preface to the next few sections, we'll be looking at the save file in more depth. This information is <a href="https://bulbapedia.bulbagarden.net/wiki/Save_data_structure_(Generation_III)">from Bulbapedia</a>.</p>
<h4 id="entire-sram-region">Entire SRAM Region</h4>
<table>
<thead>
<tr>
<th>Start Address</th>
<th>End Address</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0</td>
<td>0xDFFF</td>
<td>0xE000</td>
<td>Save Slot A</td>
</tr>
<tr>
<td>0xE000</td>
<td>0x1C000</td>
<td>0xE000</td>
<td>Save Slot B</td>
</tr>
<tr>
<td>0x1C000</td>
<td>0x1E000</td>
<td>0x2000</td>
<td>Hall of Fame</td>
</tr>
<tr>
<td>0x1E000</td>
<td>0x1F000</td>
<td>0x2000</td>
<td>Mystery Gift/e-Reader</td>
</tr>
<tr>
<td>0x1F000</td>
<td>0x200000</td>
<td>0x2000</td>
<td>Recorded Battles</td>
</tr>
</tbody>
</table>
<h4 id="single-save-slot">Single Save Slot</h4>
<table>
<thead>
<tr>
<th>Start Address</th>
<th>End Address</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0</td>
<td>0x0FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x1000</td>
<td>0x1FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x2000</td>
<td>0x2FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x3000</td>
<td>0x3FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x4000</td>
<td>0x4FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x5000</td>
<td>0x5FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x6000</td>
<td>0x6FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x7000</td>
<td>0x7FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x8000</td>
<td>0x8FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0x9000</td>
<td>0x9FFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0xA000</td>
<td>0xAFFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0xB000</td>
<td>0xBFFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0xC000</td>
<td>0xCFFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
<tr>
<td>0xD000</td>
<td>0xDFFF</td>
<td>0x1000</td>
<td>Section</td>
</tr>
</tbody>
</table>
<h4 id="section-ids">Section IDs</h4>
<table>
<thead>
<tr>
<th>ID</th>
<th>Description</th>
<th>Used Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Trainer Info</td>
<td>0x890</td>
</tr>
<tr>
<td>1</td>
<td>Team/Items</td>
<td>0xF80</td>
</tr>
<tr>
<td>2</td>
<td>Game State</td>
<td>0xF80</td>
</tr>
<tr>
<td>3</td>
<td>Misc Data</td>
<td>0xF80</td>
</tr>
<tr>
<td>4</td>
<td>Rival Info</td>
<td>0xC40</td>
</tr>
<tr>
<td>5</td>
<td>PC Buffer A</td>
<td>0xF80</td>
</tr>
<tr>
<td>6</td>
<td>PC Buffer B</td>
<td>0xF80</td>
</tr>
<tr>
<td>7</td>
<td>PC Buffer C</td>
<td>0xF80</td>
</tr>
<tr>
<td>8</td>
<td>PC Buffer D</td>
<td>0xF80</td>
</tr>
<tr>
<td>9</td>
<td>PC Buffer E</td>
<td>0xF80</td>
</tr>
<tr>
<td>10</td>
<td>PC Buffer F</td>
<td>0xF80</td>
</tr>
<tr>
<td>11</td>
<td>PC Buffer G</td>
<td>0xF80</td>
</tr>
<tr>
<td>12</td>
<td>PC Buffer H</td>
<td>0xF80</td>
</tr>
<tr>
<td>13</td>
<td>PC Buffer I</td>
<td>0x7D0</td>
</tr>
</tbody>
</table>
<p><strong>The sections in a save block do not always start at 0!</strong> The game <em>rotates</em> the save file sections every save.</p>
<h4 id="single-save-section">Single Save Section</h4>
<table>
<thead>
<tr>
<th>Start Address</th>
<th>End Address</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0</td>
<td>Varies</td>
<td>Varies</td>
<td>Data</td>
</tr>
<tr>
<td>0x0FF4</td>
<td>0x0FF6</td>
<td>0x2</td>
<td>Section ID</td>
</tr>
<tr>
<td>0x0FF6</td>
<td>0x0FF8</td>
<td>0x2</td>
<td>Checksum</td>
</tr>
<tr>
<td>0x0FF8</td>
<td>0x0FFC</td>
<td>0x4</td>
<td>Signature</td>
</tr>
<tr>
<td>0x0FFC</td>
<td>0x0FFF</td>
<td>0x4</td>
<td>Save Index</td>
</tr>
</tbody>
</table>
<p>I've set these structures up in Ghidra, ready to be used when we encounter any references to this data. There's only a few important things to remember here. Each section may contain a different amount of data, as some sections don't use all 4084 bytes available to them. The signature at the end of each section is always <code>0x8012025</code>. Finally, the save index is incremented on every save and is used to determine which save to read and write from when playing the game. The game will always load the valid save with the highest save index.</p>
<h2 id="god-save-the-rtc-data">God Save The... RTC Data?</h2>
<p>It's not particularly well documented (I just <a href="https://github.com/kwsch/PKHeX/blob/master/PKHeX.Core/Saves/Substructures/Gen3/RTC3.cs#L6">read the code</a>), but PKHeX is open source and has all of the save data structures laid out for reading. Apparently, there are two RTC data structures that store the &quot;initial&quot; time, and the &quot;elapsed&quot; time. I would guess the initial time is used to determine how much time has passed, if any, and the elapsed time is used to display your playtime on the save screen. For some reason, my saves did not have either of these things. Maybe I closed mGBA before it flushed properly? Anyways, we now know that there are two possible locations for the berry update program to read from within SRAM:</p>
<ul>
<li>SRAM + 0x98: Slot A Initial Time</li>
<li>SRAM + 0xA0: Slot A Elapsed Time</li>
<li>SRAM + 0xE098: Slot B Initial Time</li>
<li>SRAM + 0xE0A0: Slot B Elapsed Time</li>
</ul>
<p>Unfortunately, this was pretty much a dead end. There are no direct references to pretty much anywhere in SRAM accessing anything that looks like a related save file value. This either means that it doesn't happen and the save file access is for another reason, or it's abstracted in some way.</p>
<h2 id="flash-0xaaaaaaaa">FLASH! 0xAAAAAAAA!</h2>
<p>While looking through docs related to SRAM on GBATEK, I found some information regarding some memory locations in SRAM I was seeing writes to, but didn't know anything about:</p>
<!-- WriteSomethingSRAM2 -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">WriteSomethingSRAM2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token keyword">short</span> sVar1<span class="token punctuation">;</span>
 <span class="token keyword">int</span> iVar2<span class="token punctuation">;</span>
 uint uVar3<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 undefined1 auStack_50 <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">short</span> local_10<span class="token punctuation">;</span>
 
 <span class="token function">FUN_02011af8</span><span class="token punctuation">(</span>auStack_50<span class="token punctuation">)</span><span class="token punctuation">;</span>
 DAT_0e002aaa <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span>
 DAT_0e005555 <span class="token operator">=</span> <span class="token number">0x90</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>local_10 <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span> local_10 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> local_10 <span class="token operator">=</span> local_10 <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 iVar2 <span class="token operator">=</span> <span class="token function">FUN_02012ad4</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DAT_0e000001<span class="token punctuation">)</span><span class="token punctuation">;</span>
 uVar3 <span class="token operator">=</span> <span class="token function">FUN_02012ad4</span><span class="token punctuation">(</span><span class="token number">0xe000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 DAT_0e002aaa <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span>
 DAT_0e005555 <span class="token operator">=</span> <span class="token number">0xf0</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>sVar1 <span class="token operator">=</span> <span class="token number">20000</span><span class="token punctuation">;</span> sVar1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> sVar1 <span class="token operator">=</span> sVar1 <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">(</span>iVar2 <span class="token operator">&lt;&lt;</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">0x10</span> <span class="token operator">|</span> uVar3 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>GBA Cart Backup Flash ROM<br>
Chip Identification (all device types)<br>
[E005555h]=AAh, [E002AAAh]=55h, [E005555h]=90h  (enter ID mode)<br>
dev=[E000001h], man=[E000000h]                  (get device &amp; manufacturer)<br>
[E005555h]=AAh, [E002AAAh]=55h, [E005555h]=F0h  (terminate ID mode)<br>
Used to detect the type (and presence) of FLASH chips. See Device Types below.</p>
</blockquote>
<p>This function returns the device ID. The battery in the Gen 3 Pokémon games is not there to power the RAM for the save file, it's for the RTC. Therefore, it must have non-volatile flash memory for the save file. Since the save files saved by emulators are 128 kilobytes, the size of the flash chip on these carts must be a 128K model. Alternatively, we could determine this by the fact that Gen 3 games have 2 blocks of 14 save file sections of 4K each, resulting in 112K, requiring a 128K chip. There's a number of reasons you'd want to determine the flash chip device and manufacturer; the most common reason would be timing, as different manufacturers have different timing guarantees on their chip's access.</p>
<p>The implications of this didn't click for a while, but as I was looking through the functions and the IDs, I realized that Nintendo only shipped two different 128K flash chips, both of which have IDs near the caller of the above function:</p>
<!-- FlashROMSetFunctions -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">FlashROMSetFunctions</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token keyword">short</span> flashDeviceID<span class="token punctuation">;</span>
 <span class="token keyword">int</span> <span class="token operator">*</span>readAddr<span class="token punctuation">;</span>
 undefined4 result<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 
 WAITCNT <span class="token operator">=</span> WAITCNT <span class="token operator">&amp;</span> <span class="token number">0xfffc</span> <span class="token operator">|</span> <span class="token number">3</span><span class="token punctuation">;</span>
 flashDeviceID <span class="token operator">=</span> <span class="token function">FlashROMGetDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 readAddr <span class="token operator">=</span> <span class="token operator">&amp;</span>FlashROM_FunctionTableStart<span class="token punctuation">;</span>
 result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
                 <span class="token comment">/* if we've exhausted our options, just set them anyways */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
LAB_02011e26<span class="token operator">:</span>
     FLASHROM_FUNC_1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>readAddr<span class="token punctuation">;</span>
     FLASHROM_FUNC_2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     FLASHROM_FUNC_3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     FLASHROM_FUNC_4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     FLASHROM_FUNC_5 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     FLASHROM_DAT_1 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>undefined4 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     FLASHROM_DAT_2 <span class="token operator">=</span> <span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> result<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
                 <span class="token comment">/* if flash type matches ID at +0x2c, use these functions */</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>flashDeviceID <span class="token operator">==</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>readAddr <span class="token operator">+</span> <span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">goto</span> LAB_02011e26<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   readAddr <span class="token operator">=</span> readAddr <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span> true <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><em>Comments and names were, of course, added after an hour of staring at this function.</em></p>
<p>First, this function gets the flash chip device ID. It then iterates over an area of memory that contains pointers to functions and data, checking if the ID is equal to the memory at <code>+0x2c</code>, which is a flash chip ID. If it matches, it sets its return value to 0 for success, and sets function pointers in RAM to specific functions used to handle that specific chip. Thanks to this, we've filled in an entire section in <code>BerryUpdateMain</code>: after it gets the time, and before it applies the patch. We still have no evidence of save file access, though.</p>
<h2 id="the-save-file">The Save File</h2>
<p>Now that we know a number of <code>BerryUpdateMain</code> functions and their order, we can continue down the list. After setting up the flash chip reading functions and data, we can continue to the next unknown function. Clicking through into function after function, we finally get to something that compares <code>DAT_03001234+0xFF8</code> with <code>0x8012025</code>... Is this accessing the save file?</p>
<p>YES! YES IT IS! Here's an excerpt:</p>
<!-- Save file access code -->
<pre class="language-c" tabindex="0"><code class="language-c"> <span class="token keyword">do</span> <span class="token punctuation">{</span>
   <span class="token comment">// do save slot A</span>
   <span class="token function">CopyGameSaveSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span>sectionIndex<span class="token punctuation">,</span>SAV_COPY_BASE<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>signature <span class="token operator">==</span> <span class="token number">0x8012025</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     hasSave <span class="token operator">=</span> true<span class="token punctuation">;</span>
     sectionChecksum <span class="token operator">=</span> <span class="token function">ValidateSectionChecksum</span><span class="token punctuation">(</span>SAV_COPY_BASE<span class="token punctuation">,</span> relocationSpecs<span class="token punctuation">[</span>SAV_COPY_BASE<span class="token operator">-></span>sectionId<span class="token punctuation">]</span><span class="token punctuation">.</span>sectionDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>checksum <span class="token operator">==</span> sectionChecksum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       saveIndexA <span class="token operator">=</span> SAV_COPY_BASE<span class="token operator">-></span>saveIndex<span class="token punctuation">;</span>
       validSaveSectionFlags <span class="token operator">=</span> validSaveSectionFlags <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>sectionId <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   sectionIndex <span class="token operator">=</span> sectionIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>sectionIndex <span class="token operator">&lt;</span> <span class="token number">0xe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sectionsValidA <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>validSaveSectionFlags <span class="token operator">==</span> <span class="token number">0x3fff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sectionsValidA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">else</span> <span class="token punctuation">{</span>
   sectionsValidA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code></pre>
<p>It's remarkable how readable decompiled code can be once you've set up structures and names! It's obvious that the responsibility of this function is to determine 1. that the save file is valid and 2. which save file to end up using (this part was omitted from the excerpt as it is a quite long function). I've named the location that stores the highest save index <code>SAVE_INDEX</code>, and named a number of additional functions appropriately (<code>ValidateSaveAndFindHighestSaveIndex</code>, <code>CopyGameSaveSection</code>, <code>CopyBytesFromSaveSectionToDest</code>, <code>ValidateSectionChecksum</code>), despite having no idea what this construct is:</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/bIdAPlPHEF-1932.avif 1932w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/bIdAPlPHEF-1932.webp 1932w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/bIdAPlPHEF-1932.png" alt="A function on the right in Ghidra is seemingly set up to copy data from &quot;saveFileSection&quot; to &quot;dest&quot;. At the end is a function call to FUN_02012acc. The listing on the left side shows that address, but it contains an array of 2-byte values." width="1932" height="1133"></picture></p>
<p>In the function that calls <code>ValidateSaveAndFindHighestSaveIndex</code>, there's a call after it that receives the same parameter that points to section lengths that you might have seen in the excerpt above. That's how this structure was determined - it's an area of data in memory that stores memory addresses and section lengths.</p>
<!-- CopySaveSections -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">CopySaveSections</span><span class="token punctuation">(</span>undefined4 param_1<span class="token punctuation">,</span>SaveSectionRelocationSpecs <span class="token operator">*</span>specs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 word checksum<span class="token punctuation">;</span>
 uint saveSlot<span class="token punctuation">;</span>
 uint i<span class="token punctuation">;</span>
 SaveSectionRelocationSpecs <span class="token operator">*</span>_specs<span class="token punctuation">;</span>
 ushort slotIndex<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 
 <span class="token comment">// Since save slot alternates and saveIndex increments,</span>
 <span class="token comment">// save A has even saveIndex numbers,</span>
 <span class="token comment">// save B has odd saveIndex numbers</span>
 saveSlot <span class="token operator">=</span> SAVE_INDEX <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">;</span>
 slotIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
   <span class="token function">CopyGameSaveSection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>slotIndex <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>saveSlot <span class="token operator">*</span> <span class="token number">0xe0000</span> <span class="token operator">>></span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SAV_COPY_BASE<span class="token operator">-></span>data<span class="token punctuation">)</span> <span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>sectionId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     DAT_03001220 <span class="token operator">=</span> slotIndex<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   _specs <span class="token operator">=</span> specs <span class="token operator">+</span> SAV_COPY_BASE<span class="token operator">-></span>sectionId<span class="token punctuation">;</span>
   checksum <span class="token operator">=</span> <span class="token function">ValidateSectionChecksum</span><span class="token punctuation">(</span>SAV_COPY_BASE<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>_specs<span class="token operator">-></span>sectionDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
   slotIndex <span class="token operator">=</span> slotIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>signature <span class="token operator">==</span> <span class="token number">0x8012025</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>SAV_COPY_BASE<span class="token operator">-></span>checksum <span class="token operator">==</span> checksum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>_specs<span class="token operator">-></span>sectionDataSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">do</span> <span class="token punctuation">{</span>
       _specs<span class="token operator">-></span>relocationAddr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> SAV_COPY_BASE<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>ushort<span class="token punctuation">)</span>_specs<span class="token operator">-></span>sectionDataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>slotIndex <span class="token operator">&lt;</span> <span class="token number">0xe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This copies <code>specs-&gt;sectionDataSize</code> bytes from <code>saveSection</code> to <code>specs-&gt;relocationAddr</code>! This makes a ton of sense as to why there are no reads or writes to the SRAM region - it copies the entire sections it needs into memory rather than bothering to read it directly from SRAM. Now that we know what all of these memory regions are and do, we can move on to the next function from <code>BerryUpdateMain</code> that we need to figure out.</p>
<h2 id="time-difference">Time Difference</h2>
<p>The next function is a function called directly by <code>BerryUpdateMain</code>:</p>
<!-- FUN_020109a8 -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">FUN_020109a8</span><span class="token punctuation">(</span>byte <span class="token operator">*</span>p_Year<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 byte year<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 
 <span class="token function">RTCReadStatusAndYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
 year <span class="token operator">=</span> <span class="token function">BCDDecode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>g_YMDDOWStore<span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">*</span>p_Year <span class="token operator">=</span> year<span class="token punctuation">;</span>
 <span class="token function">FUN_02010874</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">,</span><span class="token operator">&amp;</span>g_UnkTime1<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_02028098<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">FUN_020108f8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_UnkTime<span class="token punctuation">,</span><span class="token operator">&amp;</span>DAT_020280a0<span class="token punctuation">,</span><span class="token operator">&amp;</span>g_UnkTime1<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> _g_UnkTime <span class="token operator">*</span> <span class="token number">1440</span> <span class="token operator">+</span> DAT_03001212 <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>DAT_03001213<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>I could have sworn I had seen some of these addresses before, so I explored a bit and found that these <code>DAT_02028098</code> references <em>are addresses from the game save copy!</em> What is it reading?</p>
<!-- Save file accesses -->
<pre class="language-c" tabindex="0"><code class="language-c"><span class="token function">FUN_02010874</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">,</span><span class="token operator">&amp;</span>g_UnkTime1<span class="token punctuation">,</span><span class="token operator">&amp;</span>SAVE_COPY_0<span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">FUN_020108f8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_UnkTime<span class="token punctuation">,</span><span class="token operator">&amp;</span>SAVE_COPY_0<span class="token punctuation">.</span>elapsed<span class="token punctuation">,</span><span class="token operator">&amp;</span>g_UnkTime1<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>It's reading the initial and elapsed time in the save file! What for?</p>
<!-- CalculateTimeDifference -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">CalculateTimeDifference</span><span class="token punctuation">(</span>byte <span class="token operator">*</span>p_Year<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 byte year<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 
 <span class="token function">RTCReadStatusAndYMDDOW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
 year <span class="token operator">=</span> <span class="token function">BCDDecode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>g_YMDDOWStore<span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">*</span>p_Year <span class="token operator">=</span> year<span class="token punctuation">;</span>
 <span class="token function">CalcInitialTimeDifference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_YMDDOWStore<span class="token punctuation">,</span><span class="token operator">&amp;</span>CurrentInitialTimeDifference<span class="token punctuation">,</span><span class="token operator">&amp;</span>SAVE_COPY_0<span class="token punctuation">.</span>initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CalcElapsedTimeDifference</span>
          <span class="token punctuation">(</span><span class="token operator">&amp;</span>ElapsedCurrentTimeDifference<span class="token punctuation">,</span><span class="token operator">&amp;</span>SAVE_COPY_0<span class="token punctuation">.</span>elapsed<span class="token punctuation">,</span><span class="token operator">&amp;</span>CurrentInitialTimeDifference<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>
 <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> 
    ElapsedCurrentTimeDifference<span class="token punctuation">.</span>day <span class="token operator">*</span> <span class="token number">1440</span> <span class="token operator">+</span> 
    ElapsedCurrentTimeDifference<span class="token punctuation">.</span>hour <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">+</span> 
    ElapsedCurrentTimeDifference<span class="token punctuation">.</span>minute<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>This calculates:</p>
<ul>
<li><strong>CurrentInitialTimeDifference</strong>: Difference in time between RTC time and Save Initial Time</li>
<li><strong>ElapsedCurrentTimeDifference</strong>: Difference in time between CurrentInitialTimeDifference and Save Elapsed Time</li>
<li><strong>Returns</strong>: 1 if the the total minutes in ElapsedCurrentTimeDifference is greater than or equal to 0, otherwise 0</li>
</ul>
<p>One interesting thing is that in order to obtain a day value, it uses the <em>broken</em> RTCDateToDayValue function from Ruby and Sapphire to do so, likely for compatibility, as it's not supposed to correct the date, it's just supposed to determine a difference. In the end, it returns a value indicating if there is a time difference between the original game's calculated elapsed time and our elapsed time. Now we can fill in the case in <code>BerryUpdateMain</code>:</p>
<!-- CalculateTimeDifference switch case -->
<pre class="language-c" tabindex="0"><code class="language-c">  <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
    <span class="token comment">// check if there is a difference in time between our calculated elapsed time and the game's calculated elapsed time</span>
    hasMinuteDiff <span class="token operator">=</span> <span class="token function">CalculateTimeDifference</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasMinuteDiff <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if there is a time difference, bail if the year is not 0</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>year <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> SET_STATE_9<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// if there is no time difference, bail if the year is not 1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>year <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>state <span class="token operator">=</span> UNABLE_TO_UPDATE<span class="token punctuation">;</span> <span class="token comment">// eventually shows "unable to update berry program"</span>
      <span class="token keyword">return</span> in_lr<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
switchD_02010398_SET_INCREMENT_STATE<span class="token operator">:</span>
    <span class="token operator">*</span>param_1 <span class="token operator">=</span> <span class="token operator">*</span>param_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span></code></pre>
<h3 id="another-day-value-another-3-hours-of-my-life">Another Day (Value), Another 3 Hours of My Life</h3>
<p>I went to go use the decompilation and the knowledge we've gained to explain why we've seen the results we have, but realized there is one more thing to examine. There is a check in later steps in <code>BerryUpdateMain</code> that can result in the patch failing even if it sets the RTC forward appropriately.</p>
<!-- Unknown 9 and 10 switch case -->
<pre class="language-c" tabindex="0"><code class="language-c"> <span class="token keyword">case</span> UNKNOWN_9<span class="token operator">:</span>
   result <span class="token operator">=</span> <span class="token function">FUN_2011864</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token operator">*</span>state <span class="token operator">=</span> UNKNOWN_10<span class="token punctuation">;</span>
     <span class="token keyword">return</span> in_lr<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">goto</span> SET_STATE_SUCCESS<span class="token punctuation">;</span>
 <span class="token keyword">case</span> UNKNOWN_10<span class="token operator">:</span>
   <span class="token function">UpdateBG</span><span class="token punctuation">(</span>IDK<span class="token punctuation">)</span><span class="token punctuation">;</span>
   result <span class="token operator">=</span> <span class="token function">FUN_0201189c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> switchD_02010398_set_UnableToUpdate<span class="token punctuation">;</span>
   g_PatchSuccess <span class="token operator">=</span> g_PatchSuccess <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">;</span>
SET_STATE_SUCCESS<span class="token operator">:</span>
   <span class="token operator">*</span>state <span class="token operator">=</span> SUCCESS<span class="token punctuation">;</span>
   <span class="token keyword">break</span><span class="token punctuation">;</span></code></pre>
<p>If the result from <code>FUN_02011864</code> is not 1, we continue to <code>UNKNOWN_10</code> rather than entering the success state outright. The process in <code>FUN_0201189C</code> can apparently fail, so even if the RTC was set forward, we get the message &quot;Unable to update the Berry Program.&quot;</p>
<!-- FUN_02011838 (GetDayValuePtrInSAVCOPY2, called by FUN_02011864 below) -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">GetDayValuePtrInSAVCOPY2</span><span class="token punctuation">(</span>uint offset<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 undefined <span class="token operator">*</span>result<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 
 offset <span class="token operator">=</span> offset <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> <span class="token number">0x4000</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>offset <span class="token operator">*</span> <span class="token number">0x10000</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   result <span class="token operator">=</span> <span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// only incoming param_1 is 0x40c2, so this always returns 0x2029D54 - SAV_COPY_2[1348]</span>
  result <span class="token operator">=</span> <span class="token operator">&amp;</span>UNK_02021bd0 <span class="token operator">+</span> offset <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>It took an obnoxious amount of time for me to parse this since I had to use my actual brain instead of letting the decompiler do all the work for me. It turns out the only argument this function ever receives is <code>0x40C2</code>, which, after the addition, puts the pointer it returns right in the middle of section 2 of the save file. I have no idea what this value is, but in my save file it is 0.</p>
<!-- FUN_02011864 (IsDayValueFromSAVCOPY2LessThanCurrentInitialTimeDifferenceDays) -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">IsDayValueFromSAVCOPY2LessThanCurrentInitialTimeDifferenceDays</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 ushort <span class="token operator">*</span>dayValue<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 byte year <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
 dayValue <span class="token operator">=</span> <span class="token punctuation">(</span>ushort <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">GetDayValuePtrInSAVCOPY2</span><span class="token punctuation">(</span><span class="token number">0x40c2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">CalculateTimeDifference</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token operator">*</span>dayValue <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>CurrentInitialTimeDifference<span class="token punctuation">.</span>day<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>I've already cleaned this function up; you can see that we're getting a day value from the save file, checking the new time difference (note this is after fixing the RTC date), and verifying that the day value for something stored in the save computes as having happened in the past. If this is not the case, we proceed to <code>UNKNOWN_10</code>, where we enter <code>FUN_0201189C</code></p>
<!-- FUN_0201189C (FixUnknownDayValue) -->
<pre class="language-c" tabindex="0"><code class="language-c">undefined8 <span class="token function">FixUnknownDayValue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
 <span class="token keyword">char</span> cVar1<span class="token punctuation">;</span>
 <span class="token keyword">int</span> dayValueLessOrEqual<span class="token punctuation">;</span>
 undefined2 <span class="token operator">*</span>p_UnknownDayValue<span class="token punctuation">;</span>
 undefined4 result<span class="token punctuation">;</span>
 undefined4 in_lr<span class="token punctuation">;</span>
 byte abStack_8 <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 undefined4 uStack_4<span class="token punctuation">;</span>
 
 uStack_4 <span class="token operator">=</span> in_lr<span class="token punctuation">;</span>

 <span class="token comment">// Check this again for some reason</span>
 dayValueLessOrEqual <span class="token operator">=</span> <span class="token function">IsDayValueFromSAVCOPY2LessThanCurrentInitialTimeDifferenceDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dayValueLessOrEqual <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
LAB_020118d0<span class="token operator">:</span>
   result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// Check it one more time, for some reason</span>
   <span class="token function">CalculateTimeDifference</span><span class="token punctuation">(</span>abStack_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>CurrentInitialTimeDifference<span class="token punctuation">.</span>day<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// If the time difference is greater than -1, fix it</span>
     p_UnknownDayValue <span class="token operator">=</span> <span class="token punctuation">(</span>undefined2 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">GetDayValuePtrInSAVCOPY2</span><span class="token punctuation">(</span><span class="token number">0x40c2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token operator">*</span>p_UnknownDayValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
     saveResult <span class="token operator">=</span> <span class="token function">CopySaveData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 means write the entire save to flash</span>
     <span class="token comment">// If we fixed it, set result 1 and return</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>saveResult <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> LAB_020118d0<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>So there we have it. That's almost the entirety of <code>BerryUpdateMain</code> figured out and labeled as to what it does. A full explanation of almost everything in the Berry Patch. Now, we can use everything we know to be able to determine why we were unable to update the berry program under certain circumstances earlier.</p>
<h2 id="inside-of-truck">INSIDE OF TRUCK</h2>
<p>Let's finally explain the behavior we were seeing earlier. Consider the following scenario:</p>
<ul>
<li><strong>Save Date</strong>: 2000-12-15 (350)</li>
<li><strong>Patch Date</strong>: 2001-01-15 (15)</li>
<li><strong>Save initial date</strong>: 0-0-0-0</li>
<li><strong>Save elapsed date</strong>: 0-0-0-0</li>
<li><strong>Unknown day value</strong>: 0</li>
<li><strong>Result</strong>: &quot;There is no need to update your Berry Program.&quot;</li>
</ul>
<p>The process for the patch is as follows:</p>
<ol>
<li><strong>Determine if patch is needed</strong>: We are on Ruby 1.1, so we can't rule out that we don't need the patch yet</li>
<li><strong>Determine if the date/time is valid</strong>: These checks are only for if the RTC has valid values, nothing to do with the game's state yet</li>
<li><strong>Set up Flash ROM handling</strong>: successful, even in emulator</li>
<li><strong>Set up save copy</strong>: successful, even in emulator</li>
<li><strong>Calculate time difference</strong>: Year = 1, Difference = True. Observing the save file, our Initial and Elapsed Time are both 0 days, 0 hours, 0 minutes. Therefore the time difference between RTC and <code>initial</code> is 15 days, and for simplicity 0 hours, minutes, and seconds. The time difference between that result and <code>elapsed</code> is also 15 days, 0 hours, minutes, and seconds</li>
<li><strong>If year is not 0, set state to <code>DO_UNKNOWN_DAY_CHECK</code></strong></li>
<li><strong>Do Unknown Day Check</strong>: DayValue = 0, DayValue &lt;= 15 days = True, no fix needed</li>
<li><strong>Set state to <code>SUCCESS</code></strong></li>
<li><strong>Check g_PatchSuccess</strong>: g_PatchSuccess is 0, set state to <code>NO_NEED_TO_UPDATE</code>. If g_PatchSuccess was 1, we would show the success screen</li>
</ol>
<p>We can finally explain why this happened - and it checks out! But you might be wondering (I was!) if I saved on December 15th, 2000, why is the date in my save 0-0-0? That is the crux of this, right? If it had the actual dates, it would make a lot more sense.</p>
<p>Recall a number of sections ago, where I wrote:</p>
<blockquote>
<p>For example, when you set the clock upstairs at your house in R/S/E, the game simply uses that as a baseline for future timed events like Shoal Cave which rely on a specific time of day, it doesn't set the RTC's time to the provided value.</p>
</blockquote>
<p>The game has no idea how to offset your local time from the RTC if you never set it. Therefore, until you set the clock upstairs in your home, the initial and elapsed times in your save file will be 0 until you do so, no matter how long you play for. D'oh. I was running all of my test cases above by saving immediately in the truck without setting the clock. What an interesting edge case!</p>
<p>Anyways, let's go ahead and try this same exact scenario again, but this time we'll set the clock upstairs and ensure that our save file has some times set in it!</p>
<ul>
<li><strong>Save Date</strong>: 2000-12-15 (350) (for real this time)</li>
<li><strong>Patch Date</strong>: 2001-01-15 (15)</li>
<li><strong>Save initial time</strong>: 349-14-00-37</li>
<li><strong>Save elapsed time</strong>: 000-10-00-00</li>
<li><strong>Unknown day value</strong>: 0</li>
</ul>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/fsPPNcwXlP-480.avif 480w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/fsPPNcwXlP-480.webp 480w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/fsPPNcwXlP-480.png" alt="A screen displaying the text &quot;Unable to update the Berry Program.&quot;" width="480" height="320"></picture></p>
<p>HUH?! Once more, let's walk through the steps. We can start on step 5 above since we know the previous steps aren't variable here.</p>
<ol>
<li><strong>Calculate time difference</strong>: Year = 1, Difference = False. The time difference between RTC and <code>initial</code> is -334 days, 9 hours, 59 minutes, and 23 seconds. The time difference between that result and <code>elapsed</code> is -336 days, 23 hours, 59 minutes, and 23 seconds. The total minutes is less than -1, so difference is false</li>
<li><strong>If there is no time difference and year is not 1, go to <code>UNABLE_TO_UPDATE</code></strong>: year is 1, so we continue to <code>UPDATE_RTC</code></li>
<li><strong>Update the RTC</strong>: The RTC was set to January 1st, 2002 at 00:00:43 and g_PatchSuccess was set to 1. The next state is <code>DO_UNKNOWN_DAY_CHECK</code></li>
<li><strong>Do Unknown Day Check</strong>: DayValue = 0, DayValue &lt;= -336 days = FALSE, fix needed, set state to <code>FIX_UNKNOWN_DAY</code></li>
<li>Unknown day fix:
<ol>
<li>Check if the fix is needed again. It still is</li>
<li>Check if <code>-1 &lt; -334</code>, it's not, so skip the block</li>
<li>Set <code>result</code> to 0 and return</li>
</ol>
</li>
<li><strong>If result is 0, go to <code>UNABLE_TO_UPDATE_2</code> and show the &quot;Unable to update Berry Program.&quot; screen</strong></li>
</ol>
<p>Jeeze, this unknown day thing is a pain! But let's think about this for a second - we're running in an emulator and the RTC was set. We can see in mGBA what the patch is trying to set the RTC to at this point, but if the patch is checking the RTC time, setting the RTC time to something different, then checking the RTC time again, the RTC hasn't actually been changed. As previously mentioned, it doesn't make much sense for mGBA and other emulators to handle RTC set commands, so it just doesn't. If we modify mGBA further with the following patch:</p>
<!-- mGBA RTC write diff -->
<pre class="language-diff" tabindex="0"><code class="language-diff">index 86ddc941f..1099f7ddb 100644
<span class="token coord">--- a/include/mgba/internal/gba/cart/gpio.h</span>
<span class="token coord">+++ b/include/mgba/internal/gba/cart/gpio.h</span>
@@ -71,6 +71,7 @@ struct GBARTC {
<span class="token unchanged"><span class="token prefix unchanged"> </span>	uint8_t time[7];
<span class="token prefix unchanged"> </span>	time_t lastLatch;
<span class="token prefix unchanged"> </span>	time_t offset;
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>	uint8_t wasSetManually;
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>};
<span class="token prefix unchanged"> </span>
<span class="token prefix unchanged"> </span>DECL_BITFIELD(GPIOPin, uint16_t);
</span>diff --git a/src/gba/cart/gpio.c b/src/gba/cart/gpio.c
index eb5328346..8f28a8ffe 100644
<span class="token coord">+++ b/src/gba/cart/gpio.c</span>
@@ -103,6 +103,7 @@ void GBAHardwareInitRTC(struct GBACartridgeHardware* hw) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>
<span class="token prefix unchanged"> </span>	hw->rtc.lastLatch = 0;
<span class="token prefix unchanged"> </span>	hw->rtc.offset = 0;
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>	hw->rtc.wasSetManually = 0;
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>}
<span class="token prefix unchanged"> </span>
</span>@@ -228,11 +247,15 @@ void _rtcProcessByte(struct GBACartridgeHardware* hw) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>			hw->rtc.control = hw->rtc.bits;
<span class="token prefix unchanged"> </span>			break;
<span class="token prefix unchanged"> </span>		case RTC_FORCE_IRQ:
</span>			mLOG(GBA_HW, STUB, "Unimplemented RTC command FORCE_IRQ");
<span class="token unchanged"><span class="token prefix unchanged"> </span>			break;
<span class="token prefix unchanged"> </span>		case RTC_RESET:
</span>			mLOG(GBA_HW, STUB, "Unimplemented RTC command RESET");
<span class="token unchanged"><span class="token prefix unchanged"> </span>		case RTC_DATETIME:
<span class="token prefix unchanged"> </span>		case RTC_TIME:
<span class="token prefix unchanged"> </span>			mLOG(GBA_HW, STUB, "RTC command %02X input byte %02X", RTCCommandDataGetCommand(hw->rtc.command), hw->rtc.bits);
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>			hw->rtc.time[6 - hw->rtc.bytesRemaining] = hw->rtc.bits;
<span class="token prefix inserted">+</span>			hw->rtc.wasSetManually = 1;
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>			break;
<span class="token prefix unchanged"> </span>		}
<span class="token prefix unchanged"> </span>	}
</span>@@ -271,6 +294,9 @@ unsigned _rtcOutput(struct GBACartridgeHardware* hw) {
<span class="token unchanged"><span class="token prefix unchanged"> </span>}
<span class="token prefix unchanged"> </span>
<span class="token prefix unchanged"> </span>void _rtcUpdateClock(struct GBACartridgeHardware* hw) {
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>
<span class="token prefix inserted">+</span>	if (hw->rtc.wasSetManually) return;
<span class="token prefix inserted">+</span>
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>	time_t t;
<span class="token prefix unchanged"> </span>	struct mRTCSource* rtc = hw->p->rtcSource;
<span class="token prefix unchanged"> </span>	if (rtc) {
</span></code></pre>
<p>Then the mGBA RTC will be set appropriately when the Berry Patch sets the RTC to a specific time, but will not tick according to realtime. That would require more code changes than I'm interested in doing at the moment. That being said, if we run the Berry Patch in the same way now, we get the following process:</p>
<ol>
<li><strong>Calculate time difference</strong>: Year = 1, Difference = False. The time difference between RTC and <code>initial</code> is -334 days, 9 hours, 59 minutes, and 23 seconds. The time difference between that result and <code>elapsed</code> is -336 days, 23 hours, 59 minutes, and 23 seconds. The total minutes is less than -1, so difference is false</li>
<li><strong>If there is no time difference and year is not 1, go to <code>UNABLE_TO_UPDATE</code></strong>: year is 1, so we continue to <code>UPDATE_RTC</code></li>
<li><strong>Update the RTC</strong>: The RTC was set to January 1st, 2002 at 00:00:43 and g_PatchSuccess was set to 1. <strong>Because of the above updates to mGBA, the next time the RTC is accessed, it will report this time.</strong> The next state is <code>DO_UNKNOWN_DAY_CHECK</code></li>
<li><strong>Do Unknown Day Check</strong>: DayValue = 0, DayValue &lt;= 733 days = TRUE, no fix needed, set state to <code>SUCCESS</code></li>
<li><strong><code>g_PatchSuccess</code> is 1, so show success screen</strong></li>
</ol>
<p>And there you have it. The fully explained Berry Patch process. Here is the table from far above, but updated with the actual values, having set the in-game clock appropriately and using the mGBA build that sets the RTC properly.</p>
<table>
<thead>
<tr>
<th>Save Date</th>
<th>Save Initial Time</th>
<th>Save Elapsed Time</th>
<th>RTC Date of Patching</th>
<th>Berry Patch Output</th>
<th>RTC Date Set To</th>
</tr>
</thead>
<tbody>
<tr>
<td>2000-01-01 (1)</td>
<td>1d,0hr,0m,23s</td>
<td>0d,10hr,1m,0s</td>
<td>2000-01-01 (1)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2001-01-01 (1)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>152d,14hr,0m,55s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-06-01 (153)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2001-06-02 (153)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>152d,14hr,0m,55s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-06-01 (152)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-02 (733)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>152d,14hr,0m,55s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-03-01 (61)</td>
<td>&quot;Unable to update the Berry Program&quot;</td>
<td>N/A</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>152d,14hr,0m,55s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-03-01 (60)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-02 (733)</td>
</tr>
<tr>
<td>2000-06-01 (153)</td>
<td>152d,14hr,0m,55s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-01-15 (15)</td>
<td>&quot;Unable to update the Berry Program&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>14d,14hr,0m,34s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-01-15 (15)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2001-01-15 (15)</td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>14d,14hr,0m,34s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-01-10 (10)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-02 (733)</td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>14d,14hr,0m,34s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-01-15 (15)</td>
<td>&quot;There is no need to update your Berry Program&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-01-15 (15)</td>
<td>14d,14hr,0m,34s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-01-20 (20)</td>
<td>&quot;There is no need to update your Berry Program&quot;</td>
<td></td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>349d,14hr,0m,33s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-12-15 (350)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2001-12-16 (350)</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>349d,14hr,0m,33s</td>
<td>0d,10hr,0m,0s</td>
<td>2000-12-31 (366)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-01 (732)</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>349d,14hr,0m,33s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-01-01 (1)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-02 (733)</td>
</tr>
<tr>
<td>2000-12-15 (350)</td>
<td>349d,14hr,0m,33s</td>
<td>0d,10hr,0m,0s</td>
<td>2001-01-15 (15)</td>
<td>&quot;Your Berry Program has been updated&quot;</td>
<td>2002-01-02 (733)</td>
</tr>
</tbody>
</table>
<p><em>Honestly, I could have narrowed this down to like 6 cases now that we know how it works, but I figured I'd just do the table over again entirely.</em></p>
<p>And that's all. I'm satisfied with what I've learned, what I've found, and the behavior I was able to describe by exploring the disassembly of the patch program.</p>
<h1 id="conclusion">Conclusion</h1>
<p>This was a super fun project and post to write. I got to explore a number of things I normally don't touch but I'm still curious about. Despite not looking into it beforehand, I feel like I got a pretty complete picture of how the software works end-to-end. There are things I didn't look at, like GBA boilerplate for things like graphics display, or the game's text encoding and sprite display, but those are not interesting to me right now.</p>
<p>If you're interested in what I looked into here, the pret project actually has full decompilation available for <a href="https://github.com/pret/pokeemerald">Pokémon Emerald</a> <strong>and</strong> the <a href="https://github.com/pret/berry-fix">Berry Update Program</a>. I didn't look until I was finished here, but it is amazing how close I got to the <a href="https://github.com/pret/berry-fix/blob/master/payload/src/main.c#L209">officially unofficial <code>BerryUpdateMain</code></a> with my labeled decompilation. Same with the <a href="https://github.com/pret/pokeemerald/blob/master/src/berry_fix_program.c#L212">berry fix code in Emerald</a>. That unknown day value in the update program? It's the day you last received a TM from the guy in Pacifidlog town. Who knew! Even though my research is complete (and redundant :)), I'll probably be reading through some of this decompilation to see how it all clicks together just to satisfy my brain.</p>
<h2 id="exercise-for-the-reader">Exercise for the Reader</h2>
<p>It took me a long time to figure out how Emerald grabs the Berry Update multiboot image. I'm going to be honest with you - I ended up searching the Emerald dump for ROM headers, finding the sub-ROM, and working backwards from there. I wanted to keep the post framed from the perspective of working at it with static analysis, but please, use all the tools available to you. I have a small Python script I used to replicate the day value code and the time difference code to understand it better. I have a 010 Editor template that parses the save and outputs the initial and elapsed times as well as the Pacifidlog town TM day value. Always use the right tool for the job!</p>
<p>On that note, when I did search through Emerald for ROM headers, something interesting popped up.</p>
<p><picture><source type="image/avif" srcset="/posts/from-scratch-berry-patch/M7LfdNQiPl-268.avif 268w"><source type="image/webp" srcset="/posts/from-scratch-berry-patch/M7LfdNQiPl-268.webp 268w"><img loading="lazy" decoding="async" src="/posts/from-scratch-berry-patch/M7LfdNQiPl-268.png" alt="Three occurrences of &quot;24 FF AE 51&quot; in the Emerald ROM dump." width="268" height="135"></picture></p>
<p>Why are there three? One is for Emerald, one is the Berry Patch, and one is <code>TEST01</code>? I wonder what that is...</p>

<ul class="links-nextprev"><li class="links-nextprev-prev">← Previous<br> <a href="/posts/modernizing-deployment/">Modernizing Software Deployment For Dummies</a></li>
</ul>

			</heading-anchors>
		</main>

		<footer>
			<p><em>Built with <a href="https://www.11ty.dev/">Eleventy v3.1.2</a></em></p>
		</footer>

		<!-- This page `/posts/from-scratch-berry-patch/` was built on 2025-07-10T04:04:24.958Z -->
		<script type="module" src="/dist/xbxy_EL6cU.js"></script>
		<script>
		// it's hacky but it works i think
		document.addEventListener('DOMContentLoaded', function() {
			const codeBlocks = document.querySelectorAll('pre > code, pre[class*="language-"]');
			
			codeBlocks.forEach(function(block) {
				const pre = block.tagName === 'PRE' ? block : block.parentElement;
				
				if (pre.classList.contains('collapsible-processed')) return;
				
				let language = 'Code';
				const classList = pre.className || block.className || '';
				const langMatch = classList.match(/language-(\w+)/);
				if (langMatch) {
					language = langMatch[1].toUpperCase();
				}
				
				let title = language;
				let prevNode = pre.previousSibling;
				
				while (prevNode) {
					if (prevNode.nodeType === Node.COMMENT_NODE) {
						title = prevNode.textContent.trim();
					} else if (prevNode.nodeType === Node.ELEMENT_NODE && prevNode.textContent.trim() !== '') {
						break;
					}
					prevNode = prevNode.previousSibling;
				}
				
				const wrapper = document.createElement('div');
				wrapper.className = 'collapsible-code-wrapper';
				
				const toggle = document.createElement('button');
				toggle.className = 'code-toggle';
				toggle.innerHTML = `
					<span class="toggle-icon">▼</span>
					<span class="toggle-text">${title}</span>
				`;
				
				const codeContainer = document.createElement('div');
				codeContainer.className = 'code-container';
				
				pre.parentNode.insertBefore(wrapper, pre);
				codeContainer.appendChild(pre);
				wrapper.appendChild(toggle);
				wrapper.appendChild(codeContainer);
				
				toggle.addEventListener('click', function() {
					const isCollapsed = codeContainer.style.display === 'none';
					
					if (isCollapsed) {
						codeContainer.style.display = 'block';
						toggle.querySelector('.toggle-icon').textContent = '▼';
						toggle.querySelector('.toggle-text').textContent = title;
					} else {
						codeContainer.style.display = 'none';
						toggle.querySelector('.toggle-icon').textContent = '▶';
						toggle.querySelector('.toggle-text').textContent = title;
					}
				});
				
				pre.classList.add('collapsible-processed');
			});
		});
		</script>
	</body>
</html>
